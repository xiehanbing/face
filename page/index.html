<!DOCTYPE html>
<html>

<head>
    <link href="../wwwroot/lib/jquery-ui-1.12.1/jquery-ui.css" rel="stylesheet" type="text/css" />
    <!-- <link href="/wwwroot/lib/checkbox/css/googleapis.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600&subset=latin,latin-ext' rel='stylesheet'> -->
    <!-- <link href="/wwwroot/lib/checkbox/css/demo.css?v=0.7.1" rel="stylesheet"> -->
    <!-- <link href="/wwwroot/lib/checkbox/skins/all.css?v=0.7.1" rel="stylesheet"> -->
    <link rel="stylesheet" type="text/css" href="../wwwroot/lib/tree/zTree_v3/css/zTreeStyle/zTreeStyle.css" />
    <link href="../wwwroot/project/index/index.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="container" id="app">
        <div class="filter-list">
            <!-- 上传图片 -->
            <div class="filter-capture-box">
                <!-- 上传图片控件 -->
                <div class="filter-capture-file-upload" id="filter-capture-file-upload">
                    <!-- 上传图片 -->
                </div>
            </div>
            <div class="filter-list-item">
                <div class="filter-list-box">
                    <div class="filter-list-item-title">摄像机:</div>
                    <div class="filter-list-item-box">
                        <div>
                            <input type="text" id="cameraSelect" disabled="disabled" class="filter-input"
                                placeholder="选择摄像机" />
                            <img class="camera-other-icon" src="../wwwroot/image/camera-other.png" />
                        </div>

                    </div>
                </div>
                <div class="filter-list-box">
                    <div class="filter-list-item-title">分析时间:</div>
                    <div class="filter-list-item-box">
                        <input type="text" id="startDatepicker" class="filter-input">
                        <span class="timeSplitSpan">至</span>
                        <input type="text" id="endDatepicker" class="filter-input">
                    </div>
                </div>
                <div class="filter-list-box">
                    <div class="filter-list-item-title">相似度:</div>
                    <div class="filter-list-item-box">
                        <input type="text" id="similarityMin" class="filter-input" placeholder="大于0且小于等于100">
                        <span class="timeSplitSpan">~</span>
                        <span class="timeSplitSpan">100</span>
                    </div>
                </div>
                <div class="filter-list-box">
                    <div class="filter-list-item-title">性别:</div>
                    <div class="filter-list-item-box">
                        <select class="filter-select" id="filter-gender" name="filter-gender">
                            <option value="">全部</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                        </select>
                    </div>
                </div>
                <div class="filter-list-box">
                    <div class="filter-list-item-title">年龄段:</div>
                    <div class="filter-list-item-box">
                        <select class="filter-select" id="filter-ageGroup" name="filter-ageGroup">
                            <option value="">全部</option>
                            <option value="CHILD">少年</option>
                            <option value="YOUNG">青年</option>
                            <option value="MIDDLE">中年</option>
                            <option value="OLD">老年</option>
                            <option value="INFANT">婴幼儿</option>
                            <option value="KID">儿童</option>
                            <option value="TEENAGER">青少年</option>
                            <option value="PRIME">壮年</option>
                            <option value="MIDDLEAGED">中老年</option>
                            <option value="UNKNOWN">未知</option>
                        </select>
                    </div>
                </div>

                <div class="filter-list-box">
                    <div class="filter-list-item-title">是否戴眼镜:</div>
                    <div class="filter-list-item-box glass-box">

                        <input type="radio" name="glass" class="glass" value="on" id="glass-1">
                        <label for="glass-1" class="glass">是</label>

                        <input type="radio" name="glass" class="glass" value="off" id="glass-2">
                        <label for="glass-2" class="glass">否</label>
                    </div>
                </div>
            </div>
            <div id="camera-tree" class="camera-tree noShow">
                <div class="camera-key-box camera-filter-box">
                    <div class="camera-tree-title floatLeft">关键字:</div>

                    <div class="floatLeft"> <input type="text" id="camera-filter" class="filter-input"></div>
                </div>
                <div class="camera-tree-box camera-filter-box">
                    <div class="camera-tree-title floatLeft">筛选:</div>
                    <div class="floatLeft">
                        <ul id="ztree" class="ztree"></ul>
                    </div>
                </div>
                <div class="camera-btn-box">
                    <div class="camera-btn camera-sure floatLeft">确定</div>
                    <div class="camera-btn camera-cancel floatLeft">取消</div>
                </div>
            </div>
        </div>
        <div class="filter-btn-box">
            <div class="filter-btn filter-btn-search">检索</div>
            <div class="filter-btn filter-btn-reset">重置</div>
        </div>

    </div>
</body>

</html>
<script src="../wwwroot/lib/jquery/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="../wwwroot/lib//jquery-ui-1.12.1/jquery-ui.js" type="text/javascript"></script>
<script src="../wwwroot/lib/checkbox/js/jquery.icheck.min.js?v=0.7.1"></script>
<script type="text/javascript" src="../wwwroot/lib/tree/zTree_v3/js/jquery.ztree.all.js"></script>
<script type="text/javascript" src="../wwwroot/lib/axios/polyfill.min.js"></script>
<script type="text/javascript" src="../wwwroot/lib/axios/axios.min.js"></script>
<script type="text/javascript" src="../wwwroot/lib/axios/my.axios.js" charset="utf8"></script>
<script type="text/javascript" src="../wwwroot/lib/message/MsgBox.js" charset="utf8"></script>
<script type="text/javascript" src="../wwwroot/lib/jquery-ui-1.12.1/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="../wwwroot/lib/jquery-ui-1.12.1/timepicker-zh-CN.js"></script>
<script src="../wwwroot/project/index/index.js" type="text/javascript"></script>
<script type="text/javascript" src="../wwwroot/project/config.js"></script>
<!-- <script src="/wwwroot/lib/dialog/jquery.dialog.js" type="text/javascript" charset="utf8"></script> -->
<script type="text/javascript">
    $(document).ready(function () {
        $('.demo-list input').iCheck({
            // checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            // increaseArea: '20%'
        });
        MySearchPeople.init();
    });
    //结构化寻人
    var MySearchPeople = {
        myTree: $('#ztree'),
        ztreeSetting: null,
        startDate: $('#startDatepicker'),
        endDate: $('#endDatepicker'),
        similarityMin: $('#similarityMin'),
        gender: $('#filter-gender'),
        ageGroup: $('#filter-ageGroup'),
        dateSetting: {
            dateFormat: 'yy-mm-dd ',
            //changeYear: true, //快速选择下拉年份
            //changeMonth: true, //快速选择下拉月份
            //monthNamesShort: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'] //且让月份显示为中文 
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
                '七月', '八月', '九月', '十月', '十一月', '十二月'
            ],
            dayNamesMin: ['日', '一', '二', '三', '四', '五', '六'],
        },
        cameraList: [],
        captureFile: null,
        cameraData: [],
        checkNodeList: [],
        preFix: '../',
        jsonUrl: '../wwwroot/data/camera.data.json',
        initMyTree: function (data) {
            var that = this;
            var setting = {
                view: {
                    showIcon: false,
                    showLine: true, //是否显示节点之间的连线
                    fontCss: {
                        'color': 'white',
                        'font-weight': 'bold',
                        'margin-bottom': '10px',
                        // 'font-size': '18px'
                    }, //字体样式函数
                    selectedMulti: true //设置是否允许同时选中多个节点
                },
                check: {
                    // chkboxType: {
                    //     "Y": "",
                    //     "N": ""
                    // },
                    chkStyle: "checkbox", //复选框类型
                    enable: true, //每个节点上是否显示 CheckBox
                    // chkDisabledInherit: true
                },
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pid",
                    },
                    key: {
                        name: "name",
                        children: "children",
                        checked: 'checked'
                    }
                },
                callback: {
                    onClick: function (event, treeId, treeNode) {
                        console.log(treeNode);
                    },
                    //勾选或取消勾选
                    onCheck: function (event, treeId, treeNode) {
                        //console.log(treeNode);
                        //获取被选中的数据
                        var nodes = ($.fn.zTree.getZTreeObj(treeId)).getCheckedNodes(true);
                        //筛选是摄像机的节点
                        var result = nodes.filter(function (item) {
                            return item.camera != null;
                        });
                        that.checkNodeList = result;
                    }
                }
            };
            this.ztreeSetting = setting;
            return this;
        },
        initCameraTree: function () {
            var that = this;
            $.axios(MyConfig.getAllCameraUrl())
                .then(function (response) {
                    var data = response.data.result.list;
                    data = data.map(function (item) {
                        return {
                            id: item.cameraIndexCode,
                            code: item.cameraIndexCode,
                            name: item.cameraName,
                            camera: 1
                        }
                    });
                    that.cameraData = data;
                    $.fn.zTree.init(that.myTree, that.ztreeSetting, data);
                    var treeObj = $.fn.zTree.getZTreeObj('ztree');
                    treeObj.expandAll(true);

                    //设置选中
                    var selectTree = window.parent.MyResult.param.cameraIndexCodes;
                    if (selectTree != null && selectTree.length > 0) {
                        var nodeList = [];
                        var cameraString = '';
                        for (var i = 0; i < selectTree.length; i++) {
                            var node = treeObj.getNodeByParam('id', selectTree[i]);
                            if (node != null) {
                                nodeList.push(node);
                                treeObj.checkNode(node, true);
                            }
                        }
                        that.cameraList = nodeList.map(function (item) {
                            cameraString += item.name + ';';
                            return {
                                name: item.name,
                                code: item.code,
                                id: item.id
                            };
                        });
                        $('#cameraSelect').val(cameraString);
                        that.checkNodeList = nodeList;
                    }
                });
            return this;
        },
        init: function () {
            this.initMyTree().initCameraTree();
            this.bindIconClick();
            this.renderDatePicker();
            this.renderSimilarityMin();
            this.renderGender();
            this.renderLayout();
            this.renderFileUpload();
            this.renderAgeGroup();
            this.renderGlass();
            this.filterBtnEvent();
            this.initCameraSureEvent();
            this.initCameraCancelEvent();
            this.initCameraKeyEvent();
            this.configRequest();
        },
        configRequest: function () {
            var that = this;
            var request = window.parent.MyResult.param;
            that.startDate.val(request.startTime);
            that.endDate.val(request.endTime);

            that.similarityMin.val(request.minSimilarity);
            //var maxSim = 100;

            that.gender.val(request.sex);
            that.gender.selectmenu("refresh"); //刷新
            that.ageGroup.val(request.ageGroup);
            that.ageGroup.selectmenu("refresh"); //刷新
            var glass = '';
            if (request.withGlass == 'YES') {
                //$('input[name=glass').val('on');
                glass = 'on';
            } else if (request.withGlass == 'NO') {
                //$('input[name=glass').val('off');
                glass = 'off';
            }
            // $('input[name=glass]').val(glass);
            //$('input[name=glass]').checkboxradio("refresh"); //刷新
            $(":radio[name='glass'][value='" + glass + "']").prop("checked", "checked");
            $('input[name=glass]').checkboxradio("refresh"); //刷新
            that.captureFile = request.facePicBinaryData;
            if (that.captureFile != null && that.captureFile != '')
                $('.filter-capture-file-upload input').parent().css({
                    'background': 'url(' + that.captureFile + ') no-repeat 0% 0%/cover'
                });
        },
        //绑定icon click 事件
        bindIconClick: function () {
            $('.camera-other-icon').click(function (e) {
                var hasClass = $('.camera-tree').hasClass('noShow');
                if (!hasClass) {
                    $('.camera-tree').addClass('noShow');

                } else {
                    showDialog('', '摄像机列表', 500, 667);

                }
            });
        },
        // 渲染日期控件
        renderDatePicker: function () {
            this.startDate.datetimepicker(this.dateSetting);
            this.endDate.datetimepicker(this.dateSetting);
            // this.startDate.datetimepicker(); // 时分秒
            // this.endDate.datetimepicker(); // 时分秒
        },
        //渲染相似度
        renderSimilarityMin: function () {
            var that = this;

            var regex = new RegExp("^100$|^(\\d|[1-9]\\d)$") //;
            that.similarityMin.keyup(function () {

                    var value = $(this).val();

                    if (regex.test(value)) {
                        // console.log(value);
                    } else {
                        $(this).val('');
                    }

                }).bind('paste', function () { //CTR+V事件处理   
                    var value = $(this).val();

                    if (regex.test(value)) {
                        //console.log(value);
                    } else {
                        $(this).val('');
                    }
                    // $(this).val($(this).val().replace(/\D|^[1-9]{2}/g, ''));
                })
                .css("ime-mode", "disabled"); //CSS设置输入法不可用 
        },
        //渲染性别
        renderGender: function () {
            this.gender.selectmenu().addClass('filter-select');
        },
        //渲染年龄段
        renderAgeGroup: function () {
            this.ageGroup.selectmenu().addClass('filter-select');
        },
        // 渲染布局
        renderLayout: function () {
            var btnBox = $('.filter-btn-box');
            var filterList = $('.filter-list');
            var width = $(window).width();
            var height = $(window).height();
            var btnBoxW = btnBox.width();
            var btnBoxTotalWidth = width - btnBoxW;
            btnBox.css({
                left: (btnBoxTotalWidth / 2) + 'px'
            });
            var filterListW = filterList.width();
            var filterListTotalWidth = width - filterListW;
            filterList.css({
                left: (filterListTotalWidth / 2) + 'px'
            });
        },
        // 渲染上传文件
        renderFileUpload: function () {
            var uploadBox = $('#filter-capture-file-upload');
            uploadBox.append('<input type="file"/>');
            var that = this;
            $(document).on('change', '.filter-capture-file-upload input', function (e) {
                var url = window.URL.createObjectURL(e.target.files[0]);
                $(this).parent().css({
                    'background': 'url(' + url + ') no-repeat 0% 0%/cover'
                });
                that.convertFileToByte(e.target.files);
            });
        },
        // 图片文件转换为base64编码后的二进制数据
        convertFileToByte: function (files) {
            var that = this;
            var reader = new FileReader();
            var file = files[0];
            var imageUrlBase64;
            if (file) {
                imageUrlBase64 = reader.readAsDataURL(file);
                reader.onload = function (e) {
                    var result = reader.result;
                    that.captureFile = result;
                    console.log(result);
                }
            }
        },
        //渲染单选框
        renderGlass: function () {
            // $('.glass').checkboxradio();
            // $("#glass").checkboxradio();
            // $("#glass-2").checkboxradio();
            $('input[name=glass]').checkboxradio();
            // $('.glass').on('change', function (event) {
            //     console.log($(event.target).val());
            //     var select = $('input[name="glass"]:checked').val();
            //     console.log(select);
            // });
        },
        filterBtnEvent: function () {
            var that = this;
            //检索
            $('.filter-btn-search').click(function () {
                var startTime = that.startDate.val();
                var endTime = that.endDate.val();

                var minSim = that.similarityMin.val();
                var maxSim = 100;

                var sex = that.gender.val();
                var age = that.ageGroup.val();

                // var glass = $('input[name=glass]:checked').val();
                var glass = $("input[name='glass']:checked").val();
                if (glass == 'on') {
                    glass = 'YES';
                }
                if (glass == 'off') {
                    glass = 'NO';
                }

                window.parent.MyResult.configRequest({
                    facePicBinaryData: that.captureFile,
                    cameraIndexCodes: that.cameraList.map(function (item) {
                        return item.code;
                    }),
                    startTime: startTime,
                    endTime: endTime,
                    minSimilarity: minSim,
                    maxSimilarity: maxSim,
                    //age: age,
                    ageGroup: age,
                    sex: sex,
                    withGlass: glass
                });
                window.parent.closeDialog();
            });
            //重置
            $('.filter-btn-reset').click(function () {
                that.resetFilterEvent();
            });

        },
        resetFilterEvent: function () {
            var that = this;
            //开始时间
            that.startDate.val('');
            //结束时间
            that.endDate.val('');

            //最小相似度
            that.similarityMin.val('');
            //var maxSim = 100;
            //性别
            that.gender.val('');
            that.gender.selectmenu("refresh"); //刷新
            //年龄
            that.ageGroup.val('');
            that.ageGroup.selectmenu("refresh"); //刷新
            //是否带眼镜
            // $(":radio[name='glass'][value='" + '' + "']").prop("checked", "checked");
            $("input:radio[name='glass']").attr("checked", false);
            $('input[name=glass]').checkboxradio("refresh"); //刷新
            //选择的文件
            that.captureFile = "";

            $('.filter-capture-file-upload input').parent().css({
                'background': 'rgba(48, 184, 255, 0.4)'
            });
            //摄像机列表反选
            var treeObj = $.fn.zTree.getZTreeObj("ztree");
            treeObj.cancelSelectedNode();
            $('#cameraSelect').val('');
            //清空列表
            that.cameraList = [];
        },
        initCameraSureEvent: function () {
            var that = this;
            $('.camera-sure').click(function (e) {
                closeDialog();
                //筛选是摄像机的节点
                var result = that.checkNodeList;
                var cameraString = '';
                that.cameraList = result.map(function (item) {
                    cameraString += item.name + ';';
                    return {
                        name: item.name,
                        code: item.code,
                        id: item.id
                    };
                });
                $('#cameraSelect').val(cameraString);
            });

        },
        initCameraCancelEvent: function () {
            $('.camera-cancel').click(function (e) {
                closeDialog();
            });
        },
        initCameraKeyEvent: function () {
            var that = this;
            $('#camera-filter').on('input', function () {
                var key = $('#camera-filter').val();
                if (key != null && key != '') {
                    var zTree = $.fn.zTree.getZTreeObj('ztree');
                    var nodeList = zTree.getNodesByParamFuzzy('name', key);
                    $.fn.zTree.init(that.myTree, that.ztreeSetting, nodeList);
                } else {
                    $.fn.zTree.init(that.myTree, that.ztreeSetting, that.cameraData);
                    var treeObj = $.fn.zTree.getZTreeObj('ztree');
                    treeObj.expandAll(true);
                }
            });

        }
    };
    // 弹框
    var titleWidth = 280;

    function showDialog(url, title, width, height) {
        if (
            width != null &&
            width != undefined &&
            typeof width == "string" &&
            width.constructor == String &&
            width.indexOf("px") >= 0
        ) {
            width = parseFloat(width.replace(/px/g, ""));
        }

        if (
            height != null &&
            height != undefined &&
            typeof height == "string" &&
            height.constructor == String &&
            height.indexOf("px") >= 0
        ) {
            height = parseFloat(height.replace(/px/g, ""));
        }

        if (!width || width > $(window).width() - 60) width = $(window).width() - 60;
        if (!height || height > $(window).height() - 60)
            height = $(window).height() - 60;
        var marginLeft = 0;
        if (width > titleWidth) {
            //titleWidth = 280;
            marginLeft = width / 2 - titleWidth / 2;
        } else {
            titleWidth = width;
        }
        $(".ui-dialog-title")
            .css("margin-left", marginLeft + "px")
            .css("width", titleWidth + "px");
        $("#camera-tree").dialog({
            title: title,
            width: width,
            height: height
        });
    }

    function closeDialog() {
        $("#camera-tree").dialog("close");
    }
</script>